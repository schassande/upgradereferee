<ion-header>
    <ion-toolbar>
        <ion-buttons slot="start">
            <ion-button (click)="navBack()">
                <ion-icon name="arrow-back"></ion-icon>
            </ion-button>
        </ion-buttons>
        <ion-title>Coach vote<span *ngIf="inputRefereeId && referee">&nbsp;on {{referee.shortName}}</span></ion-title>
        <ion-buttons slot="end">
            <ion-menu-button autoHide="false" menu="main"></ion-menu-button>
        </ion-buttons>
    </ion-toolbar>
</ion-header>
<ion-content (swipe)="onSwipe($event)">
    <ion-list>
        <ion-item *ngIf="competition || (competitions && competitions.length > 0)">
            <ion-label>Competition: </ion-label>
            <div *ngIf="!showCompetitionSelector">{{competition.name}}</div>
            <ion-select [(ngModel)]="competitionId" style="text-align: center;" interface="action-sheet" *ngIf="showCompetitionSelector" (ionChange)="onCompetitionChangeByUser()">
                <ion-select-option *ngFor="let c of competitions" value="{{c.id}}">{{c.name}}</ion-select-option>
            </ion-select>
        </ion-item>
        <div *ngIf="competition && !isCoachOfCompetition" style="margin: 5px; text-align: center; font-style: italic;">You are not a referee coach of this competition, <br>therefore you cannot vote. <br>Please select another competition.</div>
        <div *ngIf="competition && filteredReferees && !(filteredReferees.length === 0 && referee === null)">
            <ion-item *ngIf="!showDaySelector">
                <ion-label>Date: </ion-label>
                <div>{{dateService.date2string(day)}}</div>
            </ion-item>
            <div *ngIf="showDaySelector" style="margin: 5px; text-align: center;">
                <ion-icon style="float: left;" name="chevron-back" size="large" (click)="previousDay()" *ngIf="competition.days.length > 1"></ion-icon>
                <ion-icon style="float: right;" name="chevron-forward" size="large" (click)="nextDay()" *ngIf="competition.days.length > 1"></ion-icon>
                <ion-select value="{{dateService.date2string(day)}}" style="width: 60%; text-align: center; margin: auto;" interface="action-sheet" (ionChange)="onDayChange($event)">
                    <ion-select-option *ngFor="let d of competition.days; let idx = index" value="{{dateService.date2string(d)}}">Day {{idx+1}}: {{dateService.date2string(d)}}</ion-select-option>
                </ion-select>
            </div>
        </div>
        <div *ngIf="upgradeLevels && upgradeLevels.length > 1 && isCoachOfCompetition && !inputRefereeId">
            <ion-icon style="float: left;" name="chevron-back" size="large" (click)="previousLevel()"></ion-icon>
            <ion-icon style="float: right;" name="chevron-forward" size="large" (click)="nextLevel()"></ion-icon>
            <ion-select [(ngModel)]="upgradeLevel" style="text-align: center;" interface="action-sheet" (ionChange)="onUpgradeLevelChange()">
                <ion-select-option value="">All levels</ion-select-option>
                <ion-select-option *ngFor="let l of upgradeLevels" value="{{l}}">Upgrade to {{l}}</ion-select-option>
            </ion-select>
        </div>
        <ion-item *ngIf="referee && filteredReferees && filteredReferees.length === 1 && !vote">
            <ion-label>Referee: </ion-label>
            <div>{{referee.shortName}} - {{referee.firstName}} {{referee.lastName}}</div>
        </ion-item>
        <div *ngIf="competition && filteredReferees">
            <div *ngIf="filteredReferees.length === 0 && referee === null" style="font-weight: bold; text-align: center; width: 100%; margin: 20px 0;">No referee you can vote at this competition.</div>
            <div *ngIf="filteredReferees.length > 1 && showRefereeSelector" style="margin: 5px; text-align: center;">
                <ion-icon style="float: left;" name="chevron-back" size="large" (click)="previousReferee()" *ngIf="filteredReferees.length > 1"></ion-icon>
                <ion-icon style="float: right;" name="chevron-forward" size="large" (click)="nextReferee()" *ngIf="filteredReferees.length > 1"></ion-icon>
                <ion-select [(ngModel)]="selectedRefereeId" interface="action-sheet" (ionChange)="onRefereeChange()" style="width: 60%; text-align: center; margin: auto;">
                    <ion-select-option value="all">All</ion-select-option>
                    <ion-select-option *ngFor="let ref of filteredReferees" value="{{ref.id}}">{{ref.shortName}} - {{ref.firstName}} {{ref.lastName}}</ion-select-option>
                </ion-select>
            </div>
        </div>
        <div *ngIf="competitions && competitions.length === 0 && inputRefereeId && referee" style="margin: 5px; text-align: center; font-style: italic;">You don't have any common competition with the referee.</div>
        <ion-row *ngIf="referee && isCoachOfCompetition && vote" style="text-align: center;">
            <ion-col col="4">
                <img src="assets/imgs/badge/{{referee.referee.refereeLevel}}.png" height="70" alt="{{referee.referee.refereeLevel}}" />
            </ion-col>
            <ion-col col="4">
                <div>{{referee.referee.refereeCategory}}</div>
                <div>{{referee.gender == 'M' ? 'Male' : (referee.gender == 'F' ? 'Female' : '-')}}</div>
            </ion-col>
            <ion-col col="4">
                <img src="assets/imgs/badge/{{vote.upgradeLevel}}.png" alt="{{vote.upgradeLevel}}" height="70" />
            </ion-col>
        </ion-row>
        <ion-item-group style="border-left: 1px solid lightgrey; border-right: 1px solid lightgrey;" *ngIf="vote && referee && isCoachOfCompetition">
            <ion-item-divider color="light">
                <div style="text-align: center; padding: 10px; width: 100%;">
                    <div style="font-size: 1.3em; font-weight: bold;">
                        Vote for upgrade to {{vote.upgradeLevel}}
                    </div>
                    <div *ngIf="vote.closed">(closed)</div>
                    <div *ngIf="!vote.closed && !saving && (dirty || vote.dataStatus === 'NEW')">(not saved)</div>
                    <div *ngIf="!vote.closed && saving">Saving...</div>
                    <div *ngIf="!vote.closed && !saving && !dirty && vote.dataStatus === 'CLEAN'">Saved</div>
                </div>
                <ion-icon slot="end" *ngIf="vote.dataStatus === 'CLEAN' || saving" name="trash" style="margin: 0 5px;" (click)="deleteVote()"></ion-icon>
            </ion-item-divider>
            <div style="clear: both;"></div>
            <div style="font-size: 1.3em; font-weight: bold;">
                <ion-radio-group [(ngModel)]="vote.vote" [disabled]="vote.closed" name="vote" (ionChange)="onVoteChange()" style="width: 100%; margin-bottom: 10px;">
                    <ion-row style="margin-top: 10px;">
                        <ion-col col="4" style="text-align: center;">
                            <div>
                                <ion-label style="color: green; font-weight: bold;">Yes</ion-label>
                            </div>
                            <div>
                                <ion-radio value="Yes" color="success" *ngIf="!vote.closed || vote.vote ==='Yes'" [disabled]="vote.closed"></ion-radio>
                            </div>
                        </ion-col>
                        <ion-col col="4" style="text-align: center;">
                            <div>
                                <ion-label style="color: blue; font-weight: bold;">Abs</ion-label>
                            </div>
                            <div>
                                <ion-radio value="Abstain" color="primary" *ngIf="!vote.closed || vote.vote ==='Abstain'" [disabled]="vote.closed"></ion-radio>
                            </div>
                        </ion-col>
                        <ion-col col="4" style="text-align: center;">
                            <div>
                                <ion-label style="color: red; font-weight: bold;">NYC</ion-label>
                            </div>
                            <div>
                                <ion-radio value="No" color="danger" *ngIf="!vote.closed || vote.vote ==='No'" [disabled]="vote.closed"></ion-radio>
                            </div>
                        </ion-col>
                    </ion-row>
                </ion-radio-group>
                <ion-icon slot="start" name="close-outline" size="large" color="danger" *ngIf="vote.closed && vote.vote === 'No'"></ion-icon>
            </div>
            <ion-item>
                <ion-label>Comment</ion-label>
                <ion-textarea type="textarea" class="comment" autoGrow="true" inputmode="text" maxlength="500" rows="5" wrap="soft" [disabled]="vote.closed" [(ngModel)]="vote.commentForReferee" [debounce]="2000" (ionChange)="onVoteChange()"></ion-textarea>
            </ion-item>
            <ion-list *ngIf="coachings">
                <ion-item-divider color="light">Coachings during the competition ({{coachings.length}})</ion-item-divider>
                <ion-item *ngFor="let coaching of coachings" style="border: none;">
                    <ion-label>
                        {{coaching.competition}}<br>{{coachingService.getCoachingDateAsString(coaching)}} &nbsp;&nbsp;{{coaching.timeSlot}} &nbsp;&nbsp;Field {{coaching.field}}, &nbsp;&nbsp;{{coaching.gameCategory}}
                        <div> Referees: <span *ngFor="let ref of coaching.referees; last as isLast">{{ref.refereeShortName}}<span *ngIf="!isLast">, </span></span>
                            <div *ngFor="let ref of coaching.referees">
                                <div *ngIf="ref && ref.refereeId === referee.id">
                                    <div *ngIf="ref.comments">{{ref.comments}}</div>
                                    <div *ngFor="let positiveFeedback of ref.positiveFeedbacks" class="feedback">+
                                        <span [ngClass]="{'delivered': positiveFeedback.deliver}">{{positiveFeedback.skillName}}</span></div>
                                    <div *ngFor="let feedback of ref.feedbacks" class="feedback">-{{feedback.appliedLater ? '&gt;+': ''}}
                                        <span [ngClass]="{'delivered': feedback.deliver}">{{feedback.problemShortDesc}}</span></div>

                                </div>
                            </div>
                        </div>
                    </ion-label>
                </ion-item>
            </ion-list>
            <ion-list *ngIf="assessments">
                <ion-item-divider color="light">Assessements during the competition ({{assessments.length}})</ion-item-divider>
                <ion-item *ngFor="let assessment of assessments" style="border: none;">
                    <ion-label>
                        {{assessment.competition}}
                        <br>{{dateService.date2string(assessment.date)}} &nbsp;&nbsp;{{assessment.timeSlot}} &nbsp;&nbsp;Field {{assessment.field}}, &nbsp;&nbsp;{{assessment.gameCategory}}
                        <br>{{assessment.profileName}}: {{assessment.competency}}
                    </ion-label>
                </ion-item>
            </ion-list>
        </ion-item-group>
        <ion-item-group style="border-left: 1px solid lightgrey; border-right: 1px solid lightgrey;" *ngIf="summary">
            <ion-item-divider color="light">
                <div style="text-align: center; padding: 10px; width: 100%;font-size: 1.3em; font-weight: bold;">
                    Summary ({{summaryPercent}}%)
                </div>
            </ion-item-divider>
            <ion-item *ngFor="let v of summary" (click)="onRefereeSelected(v.referee.id)">
                <ion-label>{{v.referee.firstName}} {{v.referee.lastName}} ({{v.referee.referee.refereeCategory | lowercase}})</ion-label>
                <div slot="end" *ngIf="v.status === 'LOADING'">
                    <ion-spinner></ion-spinner>
                </div>
                <div slot="end" *ngIf="v.status === 'LOADED'">
                    <ion-icon name="close-outline" color="danger" *ngIf="v.vote.vote === 'No'"></ion-icon>
                    <ion-icon name="radio-button-on-outline" color="primary" *ngIf="v.vote.vote === 'Abstein' || v.vote.vote === 'Abstain'"></ion-icon>
                    <ion-icon name="checkmark-outline" color="success" *ngIf="v.vote.vote === 'Yes'"></ion-icon>
                </div>
                <div slot="end" *ngIf="v.status === 'NOT_FOUND'">TODO</div>
            </ion-item>
        </ion-item-group>
        <div *ngIf="loading" style="margin: 20px auto; text-align: center;">
            <ion-spinner></ion-spinner>
        </div>
    </ion-list>
    <div style="height: 50px;"></div>
</ion-content>